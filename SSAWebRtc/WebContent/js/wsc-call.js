/*! wsc Built on: 2016-05-11 */
var wsc=function(a){var b=a._private=a._private||{},c=a.getLogger(),d=function(){this.dataChannel=null,this.origDataChannel=null,this.state="none",this.label=null,this.onOpen=null,this.onClose=null,this.onError=null,this.dataSender=null,this.dataReceiver=null;var a=this,b=function(){a.dataSender=new e(a.dataChannel),c.info("Sender of DataTransfer created.")},d=function(){a.dataReceiver=new f,c.info("Receiver of DataTransfer created.")},g=function(b){c.debug("DataTransfer: Received data:"+b.data),a.dataReceiver?a.dataReceiver.onMessage(b):c.warn("The default data receiver is still initialized to receive data.")},h=function(e){a.origDataChannel&&(a.origDataChannel=null),a.state="open",b(),d();var f=a.dataChannel.readyState;null==a.label&&(a.label=a.dataChannel.label),c.debug('Data Channel "'+a.dataChannel.label+'" is open; current readyState: '+f),a.dataChannel.disabled=!1,a.dataChannel.onmessage=g,a.onOpen&&a.onOpen(e)},i=function(b){if(a.origDataChannel&&b.target&&a.origDataChannel.id!=b.target.id)return a.dataChannel=a.origDataChannel,void(a.origDataChannel=null);a.state="closed";var d=a.dataChannel.readyState;null==a.label&&(a.label=a.dataChannel.label),c.debug('Data Channel "'+a.dataChannel.label+'" is closing; current readyState is: '+d),a.dataChannel.disabled=!0,a.onClose&&a.onClose(b)},j=function(b){c.debug("Received dataChannel error event for DataTransfer: "+a.dataChannel.label),a.onError&&a.onError(b)};this.initDataChannel=function(b,d){if(c.debug("DataTransfer object initialized by the dataChannel."),d&&(a.origDataChannel=a.dataChannel),a.dataChannel=b,a.state="starting",a.label=b.label,a.dataChannel)try{a.dataChannel.onopen=h,a.dataChannel.onerror=j,a.dataChannel.onclose=i}catch(e){c.error("Exception occured when initializing the callback functions of the data channel: "+e)}else c.error("Could not initialize the data channel with null.")},this.clear=function(){try{null!=a.dataChannel&&(a.dataChannel.close(),a.dataChannel.disabled=!0,c.info("DataTransfer closed its data channel; current readyState is: "+a.dataChannel.readyState)),c.info("DataTransfer object cleared")}catch(b){c.error("Recieved an exception when cleaning the DataTransfer object: "+b)}},this.toJSON=function(){var a={},b={session:"",pkgInstance:""};for(var c in this)c in b||(a[c]=this[c]);return a}};d.prototype={getState:function(){return this.state},getSender:function(){return this.dataSender},getReceiver:function(){return this.dataReceiver}};var e=function(a){this.dataChannel=a};e.prototype={send:function(a){if(null!=this.dataChannel&&"open"===this.dataChannel.readyState)try{this.dataChannel.send(a)}catch(b){throw c.debug("Exception when sending data by dataChannel: "+b),b}else c.error("Error when sending data. The dataChannel is not in a valid state.")}};var f=function(){this.onMessage=function(a){c.info("onMessage function is not overridden by the application. New received data is handle by the default DataReceiver object."+a.data)}};return f.prototype={},b.DataTransfer=d,b.DataSender=e,b.DataReceiver=f,a}(wsc||{}),wsc=function(a){var b=a._private=a._private||{},c={},d=b.CallStateMachine,e=b.CallCommonUtils,f=b.rtcHelper,g=b.wscConst,h=(b.wscUtils,b.DataTransfer),i=a.getLogger(),j=(a.getLogLevel(),function(a,b){"use strict";if(!a){var c="The parameter 'session' cannot be null!";throw i.error(c),c}b?this.packageType=b:this.packageType=g.PACKAGE.CALL,a.registerPackage(this),this.session=a,this.trickleIceMode="off",this.onIncomingCall=null,this.onResurrect=null});j.prototype={getCalls:function(){"use strict";var a=[],b=this.session.getSubSessionsByPackageType(this.packageType),c=null;if(b){c=b.values();for(var d=0;d<c.length;d++)a[d]=c[d]}return a},createCall:function(a,b,c){"use strict";var d,e,f=this.session,g=this.session.userName;if(null==a||""===a)throw e="The callee cannot be empty!",i.warn(e),"CallPackage.createCall(): Empty callee exception.";return d=this.prepareCall(f,b,g,a),d.subSessionId=f.generateSubSessionId(),d.onCallError=c,d.pkgInstance=this,this.putCall(d.subSessionId,d),d},close:function(){"use strict";for(var a=this.getCalls(),b=0;b<a.length;b++){var c=a[b];c.end(),c=null}},clear:function(){for(var a=this.getCalls(),b=0;b<a.length;b++){var d=a[b];c.clearCall(d),d=null}},onMessage:function(a){"use strict";var b=this.session,c=a.control.subsession_id,d=this.session.getSubSession(c),e=a.getExtHeaders();null==d&&(d=this.prepareCall(b),d.pkgInstance=this),e&&(d.lastServerExtHeader=e),d.onMessage(a)},onRehydration:function(b){"use strict";for(var c in b.entry){var d=b.entry[c],e=d.caller,f=d.callee,g=d.callConfig,h=new k(g.audioConfig,g.videoConfig,g.dataChannelConfig),i=this.prepareCall(this.session,h,e,f);i.pkgInstance=this,i.callState=new a.CallState(d.callState.state,d.callState.status.code,d.callState.status.reason),i.earlyMediaState=d.earlyMediaState,i.subSessionId=d.subSessionId;var j;if(d.remoteMedias&&d.remoteMedias.length){j=[];for(var l=0;l<d.remoteMedias.length;l++){var m=d.remoteMedias[l],n=new Media(m.mode,m.port,m.type);j[l]=n}}i.remoteMedias=j,i.offerAnswerManager.updateState(d.offerAnswerManager.masterState),i.offerAnswerManager.updateState(d.offerAnswerManager.slaveState),i.iceTimeout=d.iceTimeout,this.putCall(c,i),this.onResurrect(i)}},prepareCall:function(a,b,c,d){"use strict";return new l(a,b,c,d)},putCall:function(a,b){this.session.putSubSession(this.packageType,a,b)},setTrickleIceMode:function(a){this.trickleIceMode=a},toJSON:function(){var a={},b={session:""};for(var c in this)c in b||(a[c]=this[c]);return a}};var k=function(a,b,c){"use strict";this.audioConfig=a,this.videoConfig=b,this.dataChannelConfig=c,this.hasAudio=function(){return null!=this.audioConfig&&(this.audioConfig===g.MEDIADIRECTION.SENDRECV||this.audioConfig===g.MEDIADIRECTION.SENDONLY)},this.hasVideo=function(){return null!=this.videoConfig&&(this.videoConfig===g.MEDIADIRECTION.SENDRECV||this.videoConfig===g.MEDIADIRECTION.SENDONLY)},this.shouldSendAudio=function(){return null!=this.audioConfig&&(this.audioConfig===g.MEDIADIRECTION.SENDRECV||this.audioConfig===g.MEDIADIRECTION.SENDONLY)},this.shouldSendVideo=function(){return null!=this.videoConfig&&(this.videoConfig===g.MEDIADIRECTION.SENDRECV||this.videoConfig===g.MEDIADIRECTION.SENDONLY)},this.shouldReceiveAudio=function(){return null!=this.audioConfig&&(this.audioConfig===g.MEDIADIRECTION.SENDRECV||this.audioConfig===g.MEDIADIRECTION.RECVONLY)},this.shouldReceiveVideo=function(){return null!=this.videoConfig&&(this.videoConfig===g.MEDIADIRECTION.SENDRECV||this.videoConfig===g.MEDIADIRECTION.RECVONLY)}},l=function(d,h,i,j){this.session=d,this.caller=i,this.callee=j,this.callConfig=h,this.dataTransfers=new a.Map,this.lastCallConfig=null,this.callState=new a.CallState(g.CALLSTATE.NONE,null,""),this.earlyMediaState=null,this.resumeState=null,this.peerConnection=null,this.onMediaStreamEvent=null,this.onCallStateChange=null,this.onDataTransfer=null,this.onUpdate=null,this.onCallError=null,this.streamAddTimes=0,this.hungupCallback=null,this.subSessionId=null,this.startReqCorrId=null,this.newRemoteSDP=null,this.newRemoteMedias=null,this.remoteMedias=null,this.localMediaStreams=[],this.temporarySavedStreams=[],this.offerAnswerManager=new b.offerAnswerManager(this);var k=2e3;this.setIceCheckInterval=function(a){if(0>=a)throw{name:"IllegalArgumentError",message:"The ICE check Interval must be greater than zero."};k=a},this.getIceCheckInterval=function(){return k},this.setCapabilityExchange=function(a){this.capabilityExchange=a},this._template={doStartCallRequest:function(a){var b=a.payload.sdp,c=f.getCallConfigFromRemoteSDP(b,!1),d=f.getCallConfigFromRemoteSDP(b,!0),g=this.parent.callState,h=a.control.subsession_id,i=a.getExtHeaders();this.parent.callConfig=c,this.parent.newRemoteSDP=a.payload,this.parent.newRemoteMedias=f.getMediaFromSDP(b),this.parent.pkgInstance.putCall(h,this.parent),g.is180Ringing()||e.send180Ringing(this.parent);var j=this.parent.pkgInstance.onIncomingCall;j&&j(this.parent,d,i)},doUpdateCallRequest:function(a){var b=a.payload.sdp,d=this.parent,e=f.getCallConfigFromRemoteSDP(b),g=a.getExtHeaders();d.lastCallConfig=d.callConfig,d.callConfig=e,d.newRemoteMedias=f.getMediaFromSDP(b),d.newRemoteSDP=a.payload,c.handleUpdateCallRequest(d,g)},doStartUnReliableProvRespWithSDP:function(a){c.handleAnswer(this.parent,a.payload)},doStart2XXResponse:function(a){c.handleAnswer(this.parent,a.payload)},doUpdate200Response:function(a){c.handleAnswer(this.parent,a.payload)},doShutdownMessage:function(){c.clearCall(this.parent)},clearCall:function(){c.clearCall(this.parent)},rollbackUpdate:function(){c.rollbackUpdate(this.parent)},doStartCallError:function(){c.clearCall(this.parent)},doStartReliableProvRespWithSDP:function(a){var b=a.payload,d=this.parent;b.type="answer";var h=d.offerAnswerManager.getMasterState();if(h===g.OFFER_ANSWER_STATE.OFFER_SENT){var i=function(){d.offerAnswerManager.updateState(g.OFFER_ANSWER_STATE.ANSWER_GOT,b.sdp),d.lastServerCorrelationId=a.control.correlation_id,e.sendPrack(d),d.offerAnswerManager.updateState(g.OFFER_ANSWER_STATE.ACK_SENT)};f.setRemoteDescription(d,new RTCSessionDescription(b),i,c.srdError(d))}},doStartReliableProvRespWithoutSDP:function(a){var b=(a.payload,this.parent);b.lastServerCorrelationId=a.control.correlation_id,e.sendPrack(b)},doStart200RespInEarlyPhase:function(a){var b=this.parent;b.earlyMediaState=null,b.setCallState(g.CALLSTATE.RESPONDED,200,"got success response"),a.complete(d),b.setCallState(g.CALLSTATE.ESTABLISHED,null,"sent complete"),e.checkResumeState(b)},doUpdate200RespInEarlyPhase:function(a){var b=this.parent;c.handleAnswer(b,a.payload),b.offerAnswerManager.updateState(g.OFFER_ANSWER_STATE.ANSWER_GOT,a.payload.sdp),a.complete(b.session),b.offerAnswerManager.updateState(g.OFFER_ANSWER_STATE.ACK_SENT),e.checkResumeState(b)},sendOffer:function(){c.sendOfferImpl(this.parent)}},this._template.parent=this};return l.prototype={start:function(b,d){function e(a){h([a])}function h(b){try{k.callConfig.dataChannelConfig&&c.initDataTransfers(k),c.initOfferCtx(k,b,d)}catch(e){k.onCallError?f.invokeCallError(k,a.ERRORCODE.PEERCONNECTION_ERROR,e):i.error("Start exception: "+e)}}function j(a){i.error("Cannot get local stream... ",a),k.fireMediaStreamEvent(g.MEDIASTREAMEVENT.LOCAL_STREAM_ERROR,null)}var k=this;if(k.callState.state!==g.CALLSTATE.NONE&&k.resumeState!==g.RESUME_STATE.reStartingCall)throw"The call has already been started";d&&(k.extHeaders=d);var l=k.callConfig.shouldSendAudio(),m=k.callConfig.shouldSendVideo();l||m?b&&b.length>0?h(b):c.initUserMedia(k,e,j):h(b)},getDataTransfer:function(a){return this.dataTransfers.get(a)},getCaller:function(){return this.caller},getCallee:function(){return this.callee},getCallState:function(){return this.callState},getCallConfig:function(){return this.callConfig?new k(this.callConfig.audioConfig,this.callConfig.videoConfig,this.callConfig.dataChannelConfig):null},getPeerConnection:function(){return this.peerConnection},toJSON:function(){var a={caller:this.caller,callee:this.callee,callConfig:this.callConfig,callState:this.callState,earlyMediaState:this.earlyMediaState,subSessionId:this.subSessionId,remoteMedias:this.remoteMedias,offerAnswerManager:this.offerAnswerManager,iceTimeout:this.iceTimeout,onDataTransfer:this.onDataTransfer};return a},setCallState:function(a,b,c){e.setCallState(this,a,b,c)},fireMediaStreamEvent:function(a,b){"use strict";if(this.onMediaStreamEvent)try{if(this.lastServerExtHeader){var c=this.lastServerExtHeader;this.onMediaStreamEvent(a,b,c),delete this.lastServerExtHeader}else this.onMediaStreamEvent(a,b)}catch(d){i.warn("The callback function 'Call.onMediaStreamEvent()' exception:"+d)}},decline:function(a,b){"use strict";try{null==a&&(a=g.ERRORCODE.DECLINED),this.callState.state===g.CALLSTATE.UPDATING?(this.callConfig=this.lastCallConfig,this.setCallState(g.CALLSTATE.UPDATE_FAILED,a,"Decline")):(f.clearPeerConnection(this),this.peerConnection=null,this.session.removeSubSession(this.subSessionId),this.setCallState(g.CALLSTATE.FAILED,a,"Decline")),e.sendReject(this,a,null,b),i.info("decline call.")}catch(c){i.error("answer error: "+c)}},accept:function(b,d,e){"use strict";function h(a){k([a])}function j(a){i.error("Cannot get local stream... ",a),l.fireMediaStreamEvent(g.MEDIASTREAMEVENT.LOCAL_STREAM_ERROR,null),l.decline()}function k(b){try{c.initAnswerCtx(l,b,e)}catch(d){l.onCallError&&f.invokeCallError(l,a.ERRORCODE.PEERCONNECTION_ERROR,d),i.error("Got exception when accept the call: "+d)}}var l=this;b||(b=this.callConfig);try{this.setCallState(g.CALLSTATE.STARTED,null,"receive call");var m=c.isValidAnswerCallConfig(this.callConfig,b);if(!m)throw{name:"InvalidCallConfig",message:"The parameter 'callConfig' is invalid."};if(this.callState.state===g.CALLSTATE.UPDATING&&null!=this.peerConnection)c.onUpdateCall(this,b,d,e);else{b&&(this.callConfig=b);var n=b.shouldSendAudio(),o=b.shouldSendVideo();n||o?d?k(d):c.initUserMedia(l,h,j):k()}i.debug("accept call")}catch(p){throw i.error("answer error: "+p),p}},end:function(a){"use strict";var b=e.createMessage(this),d="cancelled";b.header.action=g.ACTION.SHUTDOWN,b.addExtHeaders(a),this.callState.state===g.CALLSTATE.NONE||this.callState.isFinalState()||(this.callState.hasEstablished()?(b.control.correlation_id=this.session.genNewCorrelationId(),d="shutdown"):(b.control.correlation_id=this.startReqCorrId,d="cancelled"),this.session.sendMessage(b)),c.clearCall(this),this.setCallState(g.CALLSTATE.ENDED,"",d)},update:function(a,b,d){"use strict";this.setCallState(g.CALLSTATE.UPDATING,"","update"),c.updateCall(this,a,b,d)},resume:function(a,b){i.info("Begin to resume call");var c=this,d=c.temporarySavedStreams;if(c.resumeSuccessCallback=a,c.resumeFailureCallback=b,c.session.clientIpNotChangedAfterReconnect)return c.session.clientIpNotChangedAfterReconnect=!1,i.debug("Client network was not changed, no further action needed."),void(c.resumeSuccessCallback&&c.resumeSuccessCallback());var e=c.offerAnswerManager.getMasterState(),f=c.offerAnswerManager.getSlaveState(),h=g.OFFER_ANSWER_STATE;switch(i.debug("The m/s offer-answer states are: "+e+"/"+f),e){case h.INITIAL:switch(f){case h.OFFER_REJECT:case h.INITIAL:c.resumeSuccessCallback&&c.resumeSuccessCallback();break;case h.OFFER_GOT:c.resumeSuccessCallback&&c.resumeSuccessCallback();break;case h.ANSWER_SENT:c.resumeState=g.RESUME_STATE.reStartingCall,c.start(d);break;case h.ACK_GOT:c.resumeState=g.RESUME_STATE.reStartingCall,c.start(d)}break;case h.OFFER_SENT:switch(f){case h.OFFER_REJECT:case h.INITIAL:case h.OFFER_GOT:case h.ACK_GOT:c.resumeState=g.RESUME_STATE.waittingFinalResp,c.resumeSuccessCallback&&c.resumeSuccessCallback()}break;case h.ANSWER_GOT:switch(f){case h.OFFER_REJECT:case h.INITIAL:case h.OFFER_GOT:case h.GLARE:case h.ACK_GOT:case h.ANSWER_SENT:c.resumeState=g.RESUME_STATE.reStartingCall,c.start(d)}break;case h.ACK_SENT:switch(f){case h.OFFER_GOT:c.resumeSuccessCallback&&c.resumeSuccessCallback();break;case h.ANSWER_SENT:c.resumeState=g.RESUME_STATE.reStartingCall,c.start(d);break;case h.INITIAL:case h.OFFER_REJECT:case h.ACK_GOT:c.resumeState=g.RESUME_STATE.reStartingCall,c.start(d)}break;case h.OFFER_REJECTED:switch(f){case h.OFFER_REJECT:case h.INITIAL:case h.ACK_GOT:c.resumeState=g.RESUME_STATE.reStartingCall,c.start(d);break;case h.OFFER_GOT:c.resumeSuccessCallback&&c.resumeSuccessCallback();break;case h.ANSWER_SENT:c.resumeState=g.RESUME_STATE.reStartingCall,c.start(d)}}},onMessage:function(a){if(a.isEnquiry()){if(!this.capabilityExchange){var b="No CapabilityExchange registered with this call";throw i.error(b),b}this.capabilityExchange.onMessage(a)}else a.isRequest()?d.doRequest(this,a):a.isResponse()?d.doResponse(this,a):a.isMessage()?d.doMessage(this,a):a.isError()?d.doError(this,a):e.doUnexpectedMsg(this)}},c.sendOffer=function(a,b){a.offerAnswerManager.canSendOffer()&&a.peerConnection&&a.peerConnection.localDescription&&a.peerConnection.localDescription.sdp&&c.sendOfferImpl(a,b)},c.sendOfferImpl=function(a,b){if(a.callState.state===g.CALLSTATE.ENDED||a.callState.state===g.CALLSTATE.FAILED)i.warn("Call has ended while sending offer, clear the call."),c.clearCall(a);else{var d,f=e.createRequest(a),h=a.session.genNewCorrelationId();if(!a.peerConnection)return void i.warn("The peerConnection of the call is null");d=a.peerConnection.localDescription.sdp,f.header.action=g.ACTION.START,f.control.correlation_id=h,f.payload={sdp:d},b?f.addExtHeaders(b):a.extHeaders&&(f.addExtHeaders(a.extHeaders),a.extHeaders=null);var j=!1;a.authInfo&&(f.header.authorization=a.authInfo,j=!0,a.authInfo=null);try{a.session.sendMessage(f),a.startReqCorrId=f.control.correlation_id,a.offerAnswerManager.updateState(g.OFFER_ANSWER_STATE.OFFER_SENT,d),a.callState.state===g.CALLSTATE.NONE&&a.setCallState(g.CALLSTATE.STARTED,null,"start call")}catch(k){}}},c.sendAnswer=function(a,b){if(a.callState.state===g.CALLSTATE.ENDED||a.callState.state===g.CALLSTATE.FAILED)i.warn("Call has ended while sending answer, clear the call."),c.clearCall(a);else if(a&&a.peerConnection&&a.peerConnection.localDescription&&a.peerConnection.localDescription.sdp){var d=e.createResponse(a),f=a.peerConnection.localDescription.sdp,h=a.lastServerCorrelationId;d.control.message_state=g.MESSAGESTATE.FINAL,d.header.action=g.ACTION.START,d.control.correlation_id=h,b&&d.addExtHeaders(b),d.payload={sdp:f},a.session.sendMessage(d),i.debug("Answer is sent...\r\n"+f),a.setCallState(g.CALLSTATE.RESPONDED,200,"sent success response"),a.offerAnswerManager.updateState(g.OFFER_ANSWER_STATE.ANSWER_SENT,f)}},c.sendAnswerInComplete=function(a,b){var c=a.peerConnection.localDescription.sdp,d=e.createMessage(a);d.header.action=g.ACTION.COMPLETE,d.control.correlation_id=a.startReqCorrId,d.payload={sdp:c},b&&d.addExtHeaders(b),a.session.sendMessage(d),a.offerAnswerManager.updateState(g.OFFER_ANSWER_STATE.ACK_SENT,c),a.setCallState(g.CALLSTATE.ESTABLISHED,null,"sent complete")},c.initOfferCtx=function(b,d,e){"use strict";var g=b.peerConnection,h=function(){c.sendOffer(b,e)};null==b.peerConnection&&(f.createPeerConnection(b,d),g=b.peerConnection),b.callConfig.dataChannelConfig&&c.initDataChannel(b);var j=function(c){i.error("Offer error:"+c),f.invokeCallError(b,a.ERRORCODE.PEERCONNECTION_ERROR,c)},k=function(a){var d=f.changeSdpByCallConfig(a.sdp,b),e=function(){c.bindIceHandler(b,h,!0)};f.setLocalDescription(b,new RTCSessionDescription({type:"offer",sdp:d}),e)},l={OfferToReceiveAudio:b.callConfig.shouldReceiveAudio()?1:0,OfferToReceiveVideo:b.callConfig.shouldReceiveVideo()?1:0};g.createOffer(k,j,l),b.peerConnection=g},c.initAnswerCtx=function(b,d,e){"use strict";var g=b.peerConnection;null==b.peerConnection&&(f.createPeerConnection(b,d),g=b.peerConnection),b.callConfig.dataChannelConfig&&c.initReceivedDataChannel(b);var h=function(){var d=function(){c.sendAnswer(b,e)},h=function(e){var g=f.changeSdpByCallConfig(e.sdp,b),h=function(){c.bindIceHandler(b,d,!1)},j=function(c){i.warn("Set localDescription failed!"),f.invokeCallError(b,a.ERRORCODE.PEERCONNECTION_ERROR,c)};f.setLocalDescription(b,new RTCSessionDescription({type:"answer",sdp:g}),h,j)},j=function(c){i.error("Answer error:"+c),f.invokeCallError(b,a.ERRORCODE.PEERCONNECTION_ERROR,c)};g.createAnswer(h,j)},j=b.newRemoteSDP;j.type="offer";var k=new RTCSessionDescription(j);f.setRemoteDescription(b,k,h,c.srdError(b))},c.clearCall=function(a){"use strict";a&&c.clearDataTransfers(a.dataTransfers);try{f.clearPeerConnection(a),a.peerConnection=null}catch(b){i.error("clear call error: "+b)}for(var d=a.localMediaStreams,e=0;e<d.length;e++){var g=d[e];i.debug("Media stream "+e+": used by "+g.peerConnectionNum+" peer connections."),g&&(null==g.peerConnectionNum||g.peerConnectionNum<=0)&&(i.debug("Stop this media stream: [video tracks: "+g.getVideoTracks().length+", audio tracks: "+g.getAudioTracks().length+"]"),g.getTracks().forEach(function(a){a.stop()}))}a.session.removeSubSession(a.subSessionId)},c.clearDataTransfers=function(a){"use strict";if(a&&0!==a.size())for(var b=a.values(),c=null,d=0;d<b.length;d++)c=b[d],c.clear()},c.rollbackUpdate=function(a){"use strict";if(a&&a.peerConnection){var b=a.peerConnection.remoteDescription;b&&(b.type="answer",f.setRemoteDescription(a,b)),a.lastCallConfig&&(a.callConfig=a.lastCallConfig)}},c.updateCall=function(a,b,d,e){a.lastCallConfig=a.callConfig,a.callConfig=b;var f=function(b,c,d){a.peerConnection.createOffer(b,c,d)},g=function(){var b=function(){c.sendOffer(a,e)};c.bindIceHandler(a,b,!0)},h=function(){};c.doUpdate(a,b,d,f,h,g,!0)},c.closePcForUpdate=function(a,b){for(var c=f.getLocalStreams(a),d=0;d<c.length;d++){var e=c[d];e.peerConnectionNum&&e.peerConnectionNum--}a.close()},c.handleMediaStreamForUpdate=function(a,b,c,d){var e=!1,g=!1,h=(a.peerConnection,a.localMediaStreams),i=!1,j=function(b,c,d){for(var e=!1,g=0;g<b.length;g++){var h=b[g],i=h.getAudioTracks(),j=h.getVideoTracks(),k=i&&i.length>0,l=j&&j.length>0;c===k&&d===l&&(f.addLocalStream(a,h),e=!0)}return e};return b&&(i=j(b,c,d)),!i&&h&&(i=j(h,c,d)),c&&!d?e=!i:!c&&d?g=!i:c&&d&&(i||(e=g=!0,b&&(e=!j(b,!0,!1),g=!j(b,!1,!0)),(e||g)&&h&&(e&&(e=!j(h,!0,!1)),g&&(g=!j(h,!1,!0))))),{needNewAudioStream:e,needNewVideoStream:g}},c.initUserMedia=function(b,c,d,e){"use strict";var h=function(a){if(b.callState){var d=b.callState.state;if(d===g.CALLSTATE.END||d===g.CALLSTATE.FAILED)return void i.debug("Got media stream, but the call state is failed or end. So do nothing then.")}c(a)},j=function(c){if(i.error("Failed to get access to local media. Error name was "+c.name),b.callState){var e=b.callState.state;if(e===g.CALLSTATE.END||e===g.CALLSTATE.FAILED)return void i.debug("Failed to get access to local media, but the call state is failed or end. So do nothing then.")}f.invokeCallError(b,a.ERRORCODE.MEDIA_ERROR,c.name+": "+c.message),d&&d(c)};e||(e={audio:b.callConfig.shouldSendAudio(),video:b.callConfig.shouldSendVideo()});try{navigator.getUserMedia(e,h,j)}catch(k){throw i.error("The callConfig is invalid, cause initialize user media exception:"+k),k}},c.handleUpdateCallRequest=function(a,b){"use strict";var d=a.offerAnswerManager.getLatestActiveRemoteSdp();i.debug("The latest active remote SDP is: "+d),i.debug("The latest active remote medias is: "+a.remoteMedias);var h=f.isMediaChanged(a.newRemoteMedias,a.remoteMedias);h?(a.setCallState(g.CALLSTATE.UPDATING,null,"onUpdate"),a.onUpdate?a.onUpdate(a.callConfig,b):i.warn("No callback for update call request")):null==a.peerConnection||null==a.peerConnection.localDescription?(i.info("Client is not ready. Reject incoming call."),e.sendReject(a)):(f.createNewPeerConnection(a),a.offerAnswerManager.reset(),a.offerAnswerManager.updateState(g.OFFER_ANSWER_STATE.OFFER_GOT,a.newRemoteSDP.sdp),c.initAnswerCtx(a))},c.handleAnswer=function(a,b){"use strict";if(b.type="answer",a.peerConnection){var c=function(){a&&a.peerConnection&&a.peerConnection.remoteDescription};f.setRemoteDescription(a,new RTCSessionDescription(b),c)}},c.onUpdateCall=function(a,b,d,e){var g=function(){a.decline()},h=function(b,d,e){var g=new RTCSessionDescription({type:"offer",sdp:a.newRemoteSDP.sdp}),h=function(){i.debug("[UPDATE] offer is set as remote description...\r\n"+a.newRemoteSDP.sdp);var c=function(b){d(b),a.decline()};a.peerConnection.createAnswer(b,c)};f.setRemoteDescription(a,g,h,c.srdError(a))},j=function(){var b=function(){c.sendAnswer(a,e)};c.bindIceHandler(a,b,!1)};c.doUpdate(a,b,d,h,g,j,!1)},c.doUpdate=function(b,d,e,h,j,k,l){"use strict";var m=d,n=!1,o=!1,p=!1,q=!1,r=b.peerConnection;c.rollbackUpdate=function(a){var b=a.peerConnection;a.peerConnection=r,c.closePcForUpdate(b,a),a.lastCallConfig&&(a.callConfig=a.lastCallConfig)};var s=b.temporarySavedStreams;b.temporarySavedStreams=[],f.createPeerConnection(b),b.callConfig.dataChannelConfig&&(l?(c.initDataTransfers(b),c.initDataChannel(b)):c.initReceivedDataChannel(b)),b.temporarySavedStreams=s,(m.audioConfig===g.MEDIADIRECTION.SENDONLY||m.audioConfig===g.MEDIADIRECTION.SENDRECV)&&(n=!0),(m.videoConfig===g.MEDIADIRECTION.SENDONLY||m.videoConfig===g.MEDIADIRECTION.SENDRECV)&&(o=!0),(m.audioConfig===g.MEDIADIRECTION.RECVONLY||m.audioConfig===g.MEDIADIRECTION.SENDRECV)&&(p=!0),(m.videoConfig===g.MEDIADIRECTION.RECVONLY||m.videoConfig===g.MEDIADIRECTION.SENDRECV)&&(q=!0);var t=b.peerConnection,u=t.onsignalingstatechange;t.onsignalingstatechange=function(a){i.debug("signalingState: ",t.signalingState),"function"==typeof u&&u(a),"stable"===t.signalingState&&(c.closePcForUpdate(r,b),i.debug("Upgrade: the old peer connection is closed.",r),t.onsignalingstatechange=u)};var v=c.handleMediaStreamForUpdate(b,e,n,o),w=function(){if(!b.peerConnection)throw i.error("Peer connection of the call is null."),{name:"Error",message:"Peer connection of the call is null."};var d={OfferToReceiveAudio:p?1:0,OfferToReceiveVideo:q?1:0},e=function(a){i.debug("Updating call: "+a.type+" created... "+a.sdp);var c=f.changeSdpByCallConfig(a.sdp,b);a=new RTCSessionDescription({type:a.type,sdp:c}),f.setLocalDescription(b,a,k)},j=function(d){i.error("Browser failed to create sdp! The error is: ",d),b.setCallState(g.CALLSTATE.UPDATE_FAILED,a.ERRORCODE.PEERCONNECTION_ERROR,d),c.rollbackUpdate(b)};h(e,j,d)},x=function(c){var d=a.getLogLevel();d===g.LOGLEVEL.DEBUG?i.debug("[UPDATE] got local stream..."+c):d<=g.LOGLEVEL.INFO&&i.info("[UPDATE] got local stream..."),f.addLocalStream(b,c),w()},y=function(a){i.error("[Update] Cannot get local stream... ",a),b.fireMediaStreamEvent(g.MEDIASTREAMEVENT.LOCAL_STREAM_ERROR,null),j&&j(),c.rollbackUpdate(b)};if(v.needNewAudioStream||v.needNewVideoStream){var z={audio:v.needNewAudioStream,video:v.needNewVideoStream};c.initUserMedia(b,x,y,z)}else w()},c.initDataTransfers=function(a){var b,c=a.callConfig.dataChannelConfig;if(0!==c.length)for(b in c){var d=c[b],e=a.dataTransfers.get(d.label);e||(e=new h,a.dataTransfers.put(d.label,e));try{a.onDataTransfer?a.onDataTransfer(e):i.warn("The onDataTransfer() callback function is not set when starting.")}catch(f){i.warn("The callback function 'Call.onDataTransfer()' encountered an exception: "+f)}}},c.initDataChannel=function(a){var b,c=a.peerConnection,d=a.callConfig.dataChannelConfig;if(0!==d.length)for(b in d){var e=d[b],f=JSON.parse(JSON.stringify(e));delete f.label;for(var h in f)f.hasOwnProperty(h)&&-1===f[h]&&delete f[h];var j=c.createDataChannel(e.label,f),k=a.dataTransfers.get(e.label);k.initDataChannel(j,a.callState.state==g.CALLSTATE.UPDATING)}i.debug("DataChannel is initiated")},c.initReceivedDataChannel=function(a){a.peerConnection.ondatachannel=function(b){i.debug("Data channel is received");for(var c=b.channel.label,d=!1,e=0;e<a.callConfig.dataChannelConfig.length;e++)c===a.callConfig.dataChannelConfig[e]&&(d=!0);d||a.callConfig.dataChannelConfig.push({label:c,ordered:b.channel.ordered,maxPacketLifeTime:b.channel.maxPacketLifeTime,maxRetransmits:b.channel.maxRetransmits,protocol:b.channel.protocol,negotiated:b.channel.negotiated,id:b.channel.id});var f=a.getDataTransfer(c);f?i.debug("Data channel is updating."):(f=new h,i.debug("The dataTransfer object with label "+c+" is created"),a.dataTransfers.put(c,f));var g=b.channel;f.initDataChannel(g,!1);try{a.onDataTransfer?a.onDataTransfer(f):i.warn("The onDataTransfer() callback function is not set.")}catch(j){i.warn("The callback function 'Call.onDataTransfer()' exception: "+j)}a.session.saveToStorage()}},c.bindIceHandler=function(a,b,c){function d(){q.onicecandidate=k,q.oniceconnectionstatechange=l}function g(){a.peerConnection.onicecandidate=j,b()}function h(a){return'{"candidate: "'+a.candidate+'", "sdpMid:"'+a.sdpMid+'", "sdpMlineIndex:'+a.sdpMLineIndex+"}"}function j(a){var b=a.candidate;b?(i.debug("handleNewIceCandidate: candidate- "+h(b)),n(b)):(i.debug("handleNewIceCandidate: got 'end of candidates' event."),o())}function k(a){var c=a.candidate;i.debug("ICE gathering state: "+q.iceGatheringState),c?i.debug("handleEndOfCandidate: candidate- "+h(c)):(i.debug("handleEndOfCandidate: got 'end of candidates' event."),b(),q&&(q.onicecandidate=m))}function l(a){i.debug("ICE state change: "+a.target.iceConnectionState)}function m(a){var b=a.candidate;b?i.debug("logIceCandidates : candidate- "+h(b)):i.debug("logIceCandidates : end of candidates.")}function n(b){function c(){var a=h.get(d);a?a.push(g):(a=[],a.push(g),h.put(d,a))}var d,g,h=a.offerAnswerManager.trickledCandidatesMap;if(b.sdpMid)d="a=mid:"+b.sdpMid+"\r\n";else{if(null==b.sdpMLineIndex)return void i.warn("ICE Candidate is invalid, ignore it!");var j=a.offerAnswerManager.getLatestActiveLocalSdp();if(j){var k=f.getMediaFromSDP(j);if(k.length>0){var l=k[b.sdpMLineIndex];d=l.mid+"\r\n"}}}b.candidate&&(g=b.candidate),c(),a.offerAnswerManager.canSendOffer()&&e.sendTrickledCandidates(a)}function o(){for(var b=a.offerAnswerManager.trickledCandidatesMap,c=b.keys();c.length>0;){var d=c.shift(),f=b.get(d);f.push("end-of-candidates")}a.offerAnswerManager.canSendOffer()&&e.sendTrickledCandidates(a)}function p(a){return a.indexOf("a=ice-options:trickle")>-1?!0:!1}var q=(a.offerAnswerManager,a.peerConnection);if(!q)throw{name:"IllegalStateError",message:"There is no peerConnection in the call, cannot bind."};switch(a.pkgInstance.trickleIceMode){case"off":d();break;case"half":c?d():p(q.remoteDescription.sdp)?g():d();break;case"full":c||p(q.remoteDescription.sdp)?g():d();break;default:d()}},c.isValidAnswerCallConfig=function(a,b){var c={SENDRECV:6,SENDONLY:4,RECVONLY:2,NONE:1},d=b.audioConfig,e=(b.videoConfig,a.audioConfig),f=(a.videoConfig,!1);return e===g.MEDIADIRECTION.SENDONLY||e===g.MEDIADIRECTION.RECVONLY||e===g.MEDIADIRECTION.NONE?(e===d||d===g.MEDIADIRECTION.NONE)&&(f=!0):c[d]<=c[e]&&(f=!0),f},c.srdError=function(b){return function(c){i.warn("Error when set remote description: "+c),f.invokeCallError(b,a.ERRORCODE.PEERCONNECTION_ERROR,c)}},a.CallConfig=k,a.Call=l,a.CallPackage=j,console.log("wsc-call initialized."),a}(wsc||{});